/******************** 茶机控制系统 ********************
版本: v1.0
硬件版本: 0xB012
软件版本: 0xA429
通信波特率: 38400

一、系统架构
1. MCU: STM32F103VCT7
2. 外设清单:
   - USART (Modbus通信)
   - ADC (温度采集)
   - TIM3 (定时器)
   - I2C (EEPROM存储)
   - GPIO (继电器/开关控制)

二、通信协议
1. Modbus RTU
   - 从机地址: 1
   - 支持功能码: 
     * 0x03 (读保持寄存器)
     * 0x06 (写单个保持寄存器)
     * 0x10 (写多个保持寄存器)
   - 最大帧长: 接收50字节/发送200字节
   - CRC16校验

2. 关键寄存器地址
   - 0x0000-0x0010: 控制开关
   - 0x001E-0x001F: 温度和水位设置
   - 0x0025-0x0028: 流量相关参数
   - 0x0049-0x00FC: 茶配方参数区
   - 0x0168-0x0180: 状态显示区

三、配方参数结构
1. 每组配方包含:
   - 进水量(3段): 0-65535ml
   - 温度(3段): 0-100℃
   - 焖泡时间(3段): 0-65535s
   - 搅拌时间(3段): 0-65535s
   - 出茶量(3段): 0-65535ml
   - 补水补偿值

四、存储管理
1. EEPROM存储布局:
   - 0x00-0x01: 茶桶检测开关
   - 0x02-0x03: 锅炉???设置
   - 0x04-0x05: 水位阈值设置
   - 0x06-0x0D: 流量计参数
   - 0x0E-0x11: 系统保留
   - 0x12-0x17B: 配方数据区

五、异常处理机制
1. 超时保护
   - 进水超时检测
   - 加热超时检测
   - 通信超时检测

2. 异常状态字(0x0180)
   - bit9: 流量计异常
   - bit8: 温度传感器异常
   - bit7: 水位异常
   - bit6: 加热超时
   - bit5: 进水超时

六、调试接口
1. 标定功能
   - 流量标定
   - 温度校准
   - 水位校准

2. 测试模式
   - 单步测试
   - 清洗模式
   - 排污模式

七、注意事项
1. 系统初始化
   - 首次使用需进行参数初始化
   - 检查通信地址设置(默认1)
   - 确认波特率配置(38400)

2. 运行维护
   - 定期检查传感器状态
   - 记录系统异常日志
   - 定期校准流量计
   - 检查加热器工作状态
   - 水位和加热控制并行执行

3. 软件升级
   - 备份当前参数
   - 遵循升级流程
   - 验证新版本功能

4. 故障排除
   - 查看错误状态字
   - 检查通信连接
   - 验证传感器数据
   - 测试执行器动作

八、系统工作流程

1. 初始化流程
- MCU时钟初始化(64MHz)
- 延时模块初始化
- 外设初始化:
  * 继电器驱动
  * EEPROM存储器
  * 光电开关
  * ADC采集
  * LED指示
  * 定时器3(1s中断)
  * Modbus通信(38400波特率)
  * 流量计驱动

2. 主循环处理
a) 通信处理
   - Modbus指令解析执行
   - 参数更新

b) 状态监测
   - 输入信号获取
   - 异常状态检查
   - 水位状态更新
   - 温度状态更新

c) 工作模式处理
   - 空闲状态
   - 预热状态
   - 制茶状态
   - 清洗状态
   - 降温状态

3. 制茶流程(STATUS_WORK)
a) 预热阶段(STATUS_WORK_PRE)
   - 排污降温(如需要)
   - 温度调节至目标值
   - 等待温度达标

b) 进水阶段(STATUS_WORK_IN)
   - 流量计启动
   - 目标水量控制
   - 流量异常检测
   - 进水超时保护

c) 焖泡阶段(STATUS_WORK_STEW)
   - 保温控制
   - 时间计数
   - 茶桶检测(可选)
   - 搅拌控制

d) 出茶阶段(STATUS_WORK_OUT)
   - 球阀控制
   - 出茶量控制
   - 多段出茶控制
   - 复位处理

4. 保护机制
a) 水位保护
   - 开机自动排水???制(AD值 < 400时排水)
   - 双水位检测(高/低)
   - 水位异常报警
   - 缺水保护

b) 温度保护
   - 传感器故障检测
   - 加热超时保护
   - 温度异常报警

c) 流量保护
   - 流量计故障检测
   - 进水超时保护
   - 出水异常报警

5. 定时器处理(1s中断)
- 工作时间计数
- 剩余时间更新
- 超时检测
- 状态切换控制

6. 关键状态定义
a) 工作状态(status_work)
   - STATUS_WORK_PRE: 预热
   - STATUS_WORK_IN: 进水
   - STATUS_WORK_STEW: 焖泡
   - STATUS_WORK_OUT: 出茶
   - STATUS_WORK_CLN: 清洗
   - STATUS_WORK_STR: 降温

b) 水箱状态(status_water)
   - STATUS_WATER_NO: 禁止进水
   - STATUS_WATER_IDLE: 水位正常
   - STATUS_WATER_IN: 正在进水

c) 锅炉状态(status_bolier)
   - STATUS_BOLIER_NO: 禁止加热
   - STATUS_BOLIER_IDLE: 温度正常
   - STATUS_BOLIER_IN: 正在加热
   - STATUS_BOLIER_LACK: 缺水
   - STATUS_BOLIER_EOR1: 传感器故障

/*************************************************/
